@using DocuNet.Web.Dtos.Device
@using DocuNet.Web.Dtos.Connection
@using DocuNet.Web.ViewModels
@using DocuNet.Web.Constants

<div class="explorer-container @(DrawerOpen ? "open" : "")" style="@ExplorerStyle">
    <MudPaper Elevation="0" Square="true" Class="pa-0 mud-background-gray" Style="height: 100%; display: flex; flex-direction: column; overflow: hidden; border-left: 1px solid var(--mud-palette-divider);">
        <div class="pa-4 pb-2 d-flex align-center justify-space-between flex-none">
            <MudText Typo="Typo.h6" Style="font-weight: 800">EXPLORADOR</MudText>
            <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" OnClick="@(() => DrawerOpenChanged.InvokeAsync(false))" Class="d-md-none" />
        </div>
        
        <div class="flex-grow-1 pa-4 pt-0" style="overflow-y: auto;">
            @if (SelectedElement != null)
            {
                <MudPaper Class="pa-4 mb-4 mud-theme-primary" Elevation="4">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.caption" Style="opacity: 0.8; font-weight: 700;">
                            @(SelectedElementType == "node" ? "DISPOSITIVO SELECIONADO" : "CONEXÃO SELECIONADA")
                        </MudText>
                        <MudText Typo="Typo.h6" Style="line-height: 1.2">@SelectedElement.Label</MudText>
                        
                        <MudStack Row Class="mt-3" Spacing="2">
                            <MudButton Variant="Variant.Filled" Color="Color.Surface" Size="Size.Small" StartIcon="@Icons.Material.Filled.Edit" OnClick="OnEdit" FullWidth>Editar</MudButton>
                            <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small" StartIcon="@Icons.Material.Filled.Delete" OnClick="OnDelete" FullWidth Style="background: rgba(255,255,255,0.1)">Excluir</MudButton>
                        </MudStack>
                    </MudStack>
                </MudPaper>
            }

            <MudExpansionPanels MultiExpansion="true" Elevation="0">
                <MudExpansionPanel IsExpanded="true">
                    <TitleContent>
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Devices" Size="Size.Small" Class="mr-2" />
                            <MudText Typo="Typo.subtitle2"><b>Dispositivos (@Devices.Count)</b></MudText>
                        </div>
                    </TitleContent>
                    <ChildContent>
                        <MudList T="DeviceSummaryDto" Clickable="true" Dense="true" Class="pa-0">
                            @foreach (var device in Devices)
                            {
                                <MudListItem OnClick="@(() => OnFocus.InvokeAsync(device.Id.ToString()))" IconColor="@DeviceIcons.GetColor(device.Type)" Icon="@DeviceIcons.GetMudIcon(device.Type)">
                                    <div class="d-flex justify-space-between align-center">
                                        <MudText Typo="Typo.body2">@device.Name</MudText>
                                        <MudText Typo="Typo.caption" Style="opacity: 0.6">@device.IpAddress</MudText>
                                    </div>
                                </MudListItem>
                            }
                        </MudList>
                    </ChildContent>
                </MudExpansionPanel>

                <MudExpansionPanel>
                    <TitleContent>
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.SettingsEthernet" Size="Size.Small" Class="mr-2" />
                            <MudText Typo="Typo.subtitle2"><b>Conexões (@Connections.Count)</b></MudText>
                        </div>
                    </TitleContent>
                    <ChildContent>
                        <MudList T="ConnectionSummaryDto" Clickable="true" Dense="true" Class="pa-0">
                            @foreach (var conn in Connections)
                            {
                                <MudListItem OnClick="@(() => OnFocus.InvokeAsync(conn.Id.ToString()))" Icon="@Icons.Material.Filled.Link">
                                    <MudText Typo="Typo.caption" Style="display: block">@conn.SourceDeviceName → @conn.DestinationDeviceName</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@conn.SourceInterface | @conn.Speed</MudText>
                                </MudListItem>
                            }
                        </MudList>
                    </ChildContent>
                </MudExpansionPanel>
            </MudExpansionPanels>
        </div>
    </MudPaper>
</div>

@code {
    [Parameter] public bool DrawerOpen { get; set; }
    [Parameter] public EventCallback<bool> DrawerOpenChanged { get; set; }

    private string ExplorerStyle => $"width: {(DrawerOpen ? "350px" : "0px")}; " +
                                  $"min-width: {(DrawerOpen ? "350px" : "0px")}; " +
                                  $"transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); " +
                                  $"overflow: hidden; " +
                                  $"height: 100%;";

    [Parameter] public SelectedElement? SelectedElement { get; set; }
    [Parameter] public string? SelectedElementType { get; set; }
    [Parameter] public List<DeviceSummaryDto> Devices { get; set; } = new();
    [Parameter] public List<ConnectionSummaryDto> Connections { get; set; } = new();

    [Parameter] public EventCallback OnEdit { get; set; }
    [Parameter] public EventCallback OnDelete { get; set; }
    [Parameter] public EventCallback<string> OnFocus { get; set; }
}
